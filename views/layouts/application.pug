//- Simbi Application Layout
//- Converted from app/views/layouts/application.html.slim

doctype html
html(lang='en')
  head
    //- Analytics and tracking
    if env === 'production'
      include ../partials/_gtm

    //- Stylesheets
    != stylesheet_link_tag('common', 'app', 'client')

    //- Vue 0.x bundle (simbi.js)
    script(src='/simbi.js?1.1')

    //- Application scripts
    != javascript_include_tag('simbi-manifest', 'common', 'app', 'client')

    //- Mobile styles
    != stylesheet_link_tag('mobile')

    //- Favicons
    include ../partials/_favicons

    //- CSRF tokens
    != csrf_meta_tags()

    //- Meta tags
    meta(name='google-site-verification' content='V9Esb6oaBZODUJSP9ZziUocqrtZcC0F2EcR3aGJGpzQ')
    meta(property='fb:app_id' content=facebookAppId || '')

    if env === 'production'
      include ../partials/_pixel

    //- Additional head content
    != yield('head_section')

  body(class=bodyClass)
    //- Global data for client-side
    script.
      window.gon = !{JSON.stringify(gon || {})};

    //- Sentry error tracking
    unless env === 'development'
      include ../partials/_sentry

    //- Navigation bar
    include ../partials/_navbar

    //- Organization switch modal
    if orgToSwitch
      include ../partials/_org_switch_modal

    //- Modal content area
    != yield('modals')

    //- Main content wrapper
    #main-wrapper
      if !user_signed_in() || (currentUser && currentUser.allowActions)
        include ../partials/_top_alerts
        include ../partials/_bars

      //- Top section (for page-specific top content)
      != yield('top_section')

      //- Main content area
      .content(class=contentClass)
        .container
          if showSupportBanner
            include ../partials/_support_banner
          else if !hideNominateTop
            include ../partials/_nominate_banner

          //- Main page content
          != yield()

      //- Bottom section (for page-specific bottom content)
      != yield('bottom_section')

      //- Footer
      .footer
        .container
          include ../partials/_footer

    //- Bottom scripts
    != yield('bottom_scripts_section')

    //- Analytics
    include ../partials/_mixpanel

    //- User initialization
    if user_signed_in()
      script.
        simbi('initCurrentUser').then(function(initCurrentUser) {
          initCurrentUser("#{currentUser.userKey}", "#{currentUser.globalKey}");
        });

      if flashUserSignIn
        script.
          $(function() {
            mixpanel.identify(#{currentUser.id});
          });
    else
      script.
        $(function() {
          simbi('trackReferredVisit').then(function(trackReferredVisit) {
            trackReferredVisit();
          });
        });

        $(document).ready(function(){
          $('a[data-restricted="true"]').click(function(e) {
            showAlert("!{t('user.error.not_signed_up')}", 'notice');
            return false;
          });

          mixpanel.track_links('.join-btn', 'Become A Member');
        });

    //- Category search initialization
    script.
      $(document).ready(function() {
        initCategorySearch();
      });

    //- Google Translate
    #google_translate_element.hide
    script.
      function googleTranslateElementInit() {
        new google.translate.TranslateElement({
          pageLanguage: 'en',
          autoDisplay: false
        }, 'google_translate_element');
      }
    script(src='//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit')

    //- Production analytics
    if env === 'production'
      include ../partials/_ga
      include ../partials/_hotjar

    //- Intercom/Chatwoot support widget
    if user_signed_in() && !hideIntercom
      include ../partials/_chatwoot
